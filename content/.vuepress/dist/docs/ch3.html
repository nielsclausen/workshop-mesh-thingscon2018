<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 3: Working with sensors and the Particle Device Cloud | Particle Mesh Workshop</title>
    <meta name="description" content="A hands-on walkthrough of the Particle ecosystem, Particle Mesh and the new Particle Xenon.">
    
    
    <link rel="preload" href="/assets/css/6.styles.8f12b8c8.css" as="style"><link rel="preload" href="/assets/js/app.7f4038bb.js" as="script"><link rel="preload" href="/assets/js/1.b345682e.js" as="script"><link rel="prefetch" href="/assets/js/0.66ca70c1.js"><link rel="prefetch" href="/assets/js/2.93e0ad31.js"><link rel="prefetch" href="/assets/js/3.ed68baab.js"><link rel="prefetch" href="/assets/js/4.7ad0ab7d.js"><link rel="prefetch" href="/assets/js/5.3e909f84.js">
    <link rel="stylesheet" href="/assets/css/6.styles.8f12b8c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Particle Mesh Workshop
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/particle-iot/workshop-mesh-spectra" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/particle-iot/workshop-mesh-spectra" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/docs/" class="sidebar-link">About Particle Workshops</a></li><li><a href="/docs/ch1.html" class="sidebar-link">Chapter 1: Claiming your first Mesh device</a></li><li><a href="/docs/ch2.html" class="sidebar-link">Chapter 2: Setting up your first Mesh network</a></li><li><a href="/docs/ch3.html" class="active sidebar-link">Chapter 3: Working with sensors and the Particle Device Cloud</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/ch3.html#using-particle-build" class="sidebar-link">Using Particle Build</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#the-setup-and-loop-functions" class="sidebar-link">The setup() and loop() functions</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#exploring-mesh-publish-and-subscribe" class="sidebar-link">Exploring Mesh Publish and Subscribe</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#exploring-particle-publish-and-subscribe" class="sidebar-link">Exploring Particle Publish and Subscribe</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#exploring-particle-variables-and-functions" class="sidebar-link">Exploring Particle Variables and Functions</a></li></ul></li><li><a href="/docs/extra1.html" class="sidebar-link">Extra: Taking your exploration further</a></li></ul></div><div class="page"><div class="content"><h1 id="chapter-3-working-with-sensors-and-the-particle-device-cloud"><a href="#chapter-3-working-with-sensors-and-the-particle-device-cloud" aria-hidden="true" class="header-anchor">#</a> Chapter 3: Working with sensors and the Particle Device Cloud</h1><table><thead><tr><th><strong>Project Goal</strong></th><th>Explore messaging between Mesh devices, and other Particle primitives.</th></tr></thead><tbody><tr><td><strong>What you’ll learn</strong></td><td>How to: use Particle build to write device firmware; using Particle primitives to communicate between devices and networks.</td></tr><tr><td><strong>Tools you’ll need</strong></td><td>A Xenon, Ethernet Shield, Ethernet switch access, Xenon connected to a PartiBadge, the Particle Mobile App, The Particle</td></tr><tr><td><strong>Time needed to complete</strong></td><td>30 minutes</td></tr></tbody></table><p>In this final session, we'll leverage our new Mesh networks to explore more of the particle system, including:</p><ul><li>Using Particle Build to write device firmware;</li><li>Using Mesh publish and subscribe to communicate between devices on a mesh network;</li><li>Using Particle publish and subscribe to communicate between networks and devices;</li><li>Using Particle functions and variables to control devices from the Cloud.</li></ul><p>The code you'll write in this lab will live on your Gateway Xenon, and communicate with your PartiBadge in a variety of ways. By the end of this session, you'll have all the tools you need to start building Particle-powered solutions with Particle Mesh!</p><h2 id="using-particle-build"><a href="#using-particle-build" aria-hidden="true" class="header-anchor">#</a> Using Particle Build</h2><p>In this section, you'll use Particle Build to create firmware for your Gateway Xenon. Particle Build is a web-based IDE that makes it easy to program devices and learn the Particle ecosystem.</p><ol><li>Navigate to <a href="http://build.particle.io" target="_blank" rel="noopener noreferrer">build.particle.io<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. You may need to log-in, if prompted.</li></ol><p><img src="/assets/img/login.612397f2.png" alt></p><ol start="2"><li>Once you log-in, you may be directed to the Particle home page. If so, <a href="https://build.particle.io" target="_blank" rel="noopener noreferrer">click here to navigate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> back to Particle Build.</li></ol><p><img src="/assets/img/particle-home.a4565b9c.png" alt></p><ol start="3"><li>When navigating to the Web IDE (Build), the first thing you'll see is an empty editor window for a new project and a prompt to give that project a name.</li></ol><p><img src="/assets/img/newproject.68e3a433.png" alt></p><ol start="4"><li>In the Current App textbox, give your app a name (like &quot;MeshWorkshop&quot;) and hit enter.</li></ol><p><img src="/assets/img/projectname.027be1b1.png" alt></p><ol start="5"><li>Once you've given your project a name, you're ready to code!</li></ol><p><img src="/assets/img/projectnamed.cafdfc0c.png" alt></p><h2 id="the-setup-and-loop-functions"><a href="#the-setup-and-loop-functions" aria-hidden="true" class="header-anchor">#</a> The <code>setup()</code> and <code>loop()</code> functions</h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If you're new to embedded or IoT development, this section is for you!</p></div><p>Before we dive into our first bit of code, a brief word about the two functions that were auto-populated into your new app. If you've done Arduino or Particle development before, you're already familiar with these and can skip ahead. If not, read on.</p><p>Every Particle application <em>must</em> have two functions in the main file (sometimes called a &quot;sketch&quot;): <code>setup()</code> and <code>loop()</code>. Both of these functions are called by the Particle Device OS.</p><p>True to its name, <code>setup()</code> runs only only once when the device starts up and is used for initializing buttons, sensors and other things needed to get your project ready to execute.</p><p><code>loop()</code>, on the other hand, executes over and over again as long as your firmware is running on the device. When the function is called by the Device OS, the code inside executes sequentially until it reaches the closing brace of the function, before being called again.</p><p>While the speed at which the <code>loop()</code> function executes is determined by the specific hardware and the time needed to execute the use code you've written in the function, it's important to know that, much of the time, this function will run very fast.</p><p>The bulk of your program, from state management, handling user input, reading from sensors and more will take place inside of the <code>loop()</code> function. It can take a bit of getting used to if you're not familiar with this style of development, but once you become comfortable, you'll enjoy the power this control provides you as a firmware developer.</p><h2 id="exploring-mesh-publish-and-subscribe"><a href="#exploring-mesh-publish-and-subscribe" aria-hidden="true" class="header-anchor">#</a> Exploring Mesh Publish and Subscribe</h2><p>The first two Particle primitives we'll look at are also the newest, <code>Mesh.publish()</code> and <code>Mesh.subscribe()</code>. These primitives allow us to send and receive broadcast messages within a Mesh network. Unlike <code>Particle.publish()</code> and <code>Particle.subscribe()</code> which we'll look at next, these messages can only be sent to and viewed by devices on the Mesh network.</p><h3 id="using-mesh-publish"><a href="#using-mesh-publish" aria-hidden="true" class="header-anchor">#</a> Using <code>Mesh.publish()</code></h3><p>First, we're going to use <code>Particle.publish()</code> to send a message to our badges, which they've been pre-programmed to receive. Since we're working with a Xenon in an Ethernet FeatherWing, we'll use the <code>SETUP</code> button on the Xenon to fire a Mesh message.</p><ol><li>In <code>setup</code>, add the following:</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>System<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>button_click<span class="token punctuation">,</span> setupHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>System.on</code> registers a <a href="https://docs.particle.io/reference/firmware/photon/#system-events-overview" target="_blank" rel="noopener noreferrer">system event<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> tied to the <code>SETUP</code> button. When the button is clicked, a handler named <code>setupHandler</code> is called.</p><ol start="2"><li>Add the <code>setupHandler</code> above the <code>setup</code> function and replace <code>&lt;your-first-name&gt;</code> with your name.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">setupHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Mesh<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;gateway-setup-clicked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;your-first-name&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Mesh.publish()</code> is pretty simple. You pass in the name of the event and an optional data payload to pass along with the message.</p><p>When this handler is called, it will fire a multicast event to the entire Mesh network. If one or more devices on the network are listening for this event, they'll receive it and respond accordingly.</p><ol start="3"><li>Lets flash this firmware to your gateway. First, click on the crosshairs icon in the left side of Build to open your devices list.</li></ol><p><img src="/assets/img/devices.6a952842.png" alt></p><ol start="4"><li>Find your gateway Xenon in the list and click the &quot;star&quot; next to its name to set it as your active device. Keep the default firmware selection.</li></ol><p><img src="/assets/img/devicesList.908c0d63.png" alt></p><ol start="5"><li>Click the lightning-bolt icon at the top left side of the screen to flash your device.</li></ol><p><img src="/assets/img/lightning.34671389.png" alt></p><ol start="6"><li>Once your gateway is breathing cyan again, click and release the <code>SETUP</code> button. You should see your badge respond to the event with your name!</li></ol><p>If you're interested in seeing the subscribe side of this code before you write your own, you can view it in the <a href="https://github.com/particle-iot/" target="_blank" rel="noopener noreferrer">GitHub repo for the PartiBadge<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The <code>Mesh.subscribe</code> code is <a href>here</a> and the handler is <a href>here</a>.</p><h3 id="using-mesh-subscribe"><a href="#using-mesh-subscribe" aria-hidden="true" class="header-anchor">#</a> Using <code>Mesh.subscribe()</code></h3><p>Now let's write our own <code>Mesh.subscribe()</code> logic to receive an event preprogrammed into your badges.</p><ol><li>Add the following to <code>setup</code>:</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">pinMode</span><span class="token punctuation">(</span>D7<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

Mesh<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;gateway-ping&quot;</span><span class="token punctuation">,</span> pingHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In addition to setting up a subscription handler, we call <code>pinMode</code> to designate how a given General Purpose Input-Output (GPIO) pin on the Xenon will be used, either as an input (common with buttons and switches), or an output (common with LEDs, speakers and displays).</p><ol start="2"><li>Above the <code>setup</code> function, add the <code>pingHandler</code>. We don't need the two parameters for this step, but they are required on all event handlers.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">pingHandler</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> event<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>D7<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>D7<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the <code>pingHandler</code> is called, it will turn the <code>D7</code> pin on by setting it high. On every Particle device, including the Xenon, the <code>D7</code> pin is connected to an onboard blue LED. So, by setting <code>D7</code><code>HIGH</code>, you'll be turning on that LED each time an event is received. After 2 seconds (or 2000 milliseconds), the LED will be turned off.</p><ol start="3"><li>Click the lightning icon to flash the latest code to your device. On your PartiBadge, the &quot;gateway-ping&quot; event is available from the &quot;Mesh Tools&quot; menu. Navigate to that menu and click the &quot;Ping Gateway&quot; menu item to fire the event.</li></ol><h2 id="exploring-particle-publish-and-subscribe"><a href="#exploring-particle-publish-and-subscribe" aria-hidden="true" class="header-anchor">#</a> Exploring Particle Publish and Subscribe</h2><ul><li>Particle Publish and Subscribe.</li><li>Publish an event to the badge that fade blinks an LED.</li><li>For extra credit, find a partner at your table and set-up Publish/Subscribe between your devices.</li></ul><h2 id="exploring-particle-variables-and-functions"><a href="#exploring-particle-variables-and-functions" aria-hidden="true" class="header-anchor">#</a> Exploring Particle Variables and Functions</h2><ul><li>Particle Variables and Functions.</li><li>Add a variable to return the current state of the D7 pin.</li><li>Add a function to toggle the state of the D7 pin.</li></ul></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/particle-iot/workshop-mesh-spectra/edit/master/docs/ch3.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/docs/ch2.html" class="prev">
          Chapter 2: Setting up your first Mesh network
        </a></span><span class="next"><a href="/docs/extra1.html">
          Extra: Taking your exploration further
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/1.b345682e.js" defer></script><script src="/assets/js/app.7f4038bb.js" defer></script>
  </body>
</html>
